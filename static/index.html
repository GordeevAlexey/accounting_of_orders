<!DOCTYPE html>
<?php header('Access-Control-Allow-Origin: *'); ?>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Система учета поручений</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.1.1/css/tabulator.min.css" rel="stylesheet">
<!--<link href="https://github.com/olifolkerd/tabulator/blob/master/dist/css/tabulator_materialize.min.css" rel="stylesheet">-->
<!--<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.1.1/css/bootstrap/tabulator_bootstrap4.min.css" rel="stylesheet">-->
<link href="static/tabulator.min.css" rel="stylesheet">
<style>
            <style>

            body {
                background-color: white;
                 }

            img {
            width: 250px;
            align: center;
                }

            p {
            font-family: sans-serif;
            font-size: 30px;
            text-align: center
            }

            form {
                text-align:center;
                 }

            h1 {
                font-variant: small-caps;
                color: rgba(0, 0, 153,.7)
                }

            orders {
            font-variant: small-caps;
            }

            .input_css, select{
                font-variant: small-caps;
                width:400px;
                padding:25px;
                border-radius: 10px;
                border:0;
                box-shadow:0 0 15px 2px rgba(60,74,123,.7);
                border-bottom:1px ;
                box-sizing: border-box;
                margin:8px;

            }

            textarea{
                font-family: Verdana;
                font-size: 30;
                width:400px;
                height:400px;
                padding:18px;
                border-radius: 10px;
                border:0;
                box-shadow:0 0 15px 2px rgba(60,74,123,.7);
                border-bottom:1px ;
                box-sizing: border-box;
                margin:8px
            }

            input:hover, input:focus,
            button:hover, button:focus,
            select:hover, select:focus {
                box-shadow:0 0 15px 2px rgba(60,123,68,.7);
                background: rgba(60,123,68,.1);
                outline:0;
            }

            #delete_suborder_btn:hover, #delete_suborder_btn:focus {
                box-shadow:0 0 15px 2px rgba(245,80,80,.7);
                background: rgba(245,80,80,.1);
            }

            #update_suborder_btn:hover, #update_suborder_btn:focus {
                box-shadow:0 0 15px 2px rgba(204,204,0,.7);
                background: rgba(204,204,0,.1);
            }
</style>
<style>
            .modalwin {
                height: 800px;
                width: 550px;
                border: 3px outset gray;
                background: Gainsboro;
                top: 10%; /* отступ сверху */
                right: 0;
                left: 0;
                font-size: 14px;
                margin: 0 auto;
                z-index:2; /* поверх всех */
                display: none;  /* сначала невидим */
                position: fixed; /* фиксированное позиционирование, окно стабильно при прокрутке */
                padding: 15px;
                border: 1px solid #383838;
            }

            #shadow {
                position: fixed;
                width:100%;
                height:100%;
                z-index:1; /* поверх всех  кроме окна*/
                background:#000;
                opacity: 0.7; /*прозрачность*/
                left:0;
                top:0;
            }
        </style>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.1.1/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>

<body>
<div id="orders_manual">
    <h1>Реестр документов</h1>
    <input type="button" class="input_css" value="Добавить документ" onclick="showModalWin('add_order')">
    <input id="update_order_btn" class="input_css" type="button" value="Редактировать приказ" onclick="showModalWin('update_order')" hidden>
</div>
    <div align="right">
        <input type="date" id="date_start">
        <br>
        <br>
        <input type="date" id="date_end">
        <br>
        <br>
        <input type="button" value="Сформировать отчет" onclick="get_report();">
        <br>
        <br>
    </div>




<div id="orders"></div>
<div id="suborders_manual" hidden>
    <h1>Реестр поручений</h1>
    <input id="add_task" class="input_css" type="button" value="Добавить поручение" onclick="showModalWin('add_suborder')">
    <input id="close_task" class="input_css" type="button" value="Закрыть поручение" onclick="showModalWin('close_suborder')" hidden>
    <br>
    <input id="update_suborder_btn" class="input_css" type="button" value="Редактировать поручение" onclick="showModalWin('update_suborder')" hidden>
    <input id="delete_suborder_btn" class="input_css" type="button" value="Удалить поручение" onclick="deleteSuborder()" hidden>

</div>

<div id="suborders"></div>

<div style="text-align: center" id="add_order" class="modalwin">
    <form action="/add_order" method="post">
        <select class="js-example-basic-multiple" name="issue_type" id="issue_type">
            <option value="Приказ" selected>Приказ</option>
            <option value="Распоряжение" selected>Распоряжение</option>
        </select>
        <input name="issue_idx" class="input_css" type="text" placeholder="Номер №">
        <input name="approving_date" class="input_css" type="text" onfocus="(this.type='date')" onblur="(this.value == '' ? this.type='text' : this.type='date')" placeholder="Дата утверждения">
        <input name="title" class="input_css" type="text" placeholder="Тема">

        <select class="initiator" name="initiator" id="initiator" multiple="multiple"></select>
        <br><br>
        <select class="approving_employee" name="approving_employee" id="approving_employee" multiple="multiple"></select>
        <br><br>
        <select class="employee_order" name="employee_order" id="employee_order" multiple="multiple"></select>

        <input name="deadline" class="input_css" type="text" onfocus="(this.type='date')" onblur="(this.value == '' ? this.type='text' : this.type='date')" placeholder="Срок исполнения">
        <input name="comment" class="input_css" type="text" placeholder="Примечание">
        <input name="reference" class="input_css" type="link" placeholder="Ссылка">

        <input type="submit" class="input_css" name="submit" value="Сохранить">

    </form>
</div>

<div style="text-align: center" id="update_order" class="modalwin">
<!--    <form id="update_order_form" action="" method="post" onsubmit="return addActionForm('update_order', 'update_order');">-->
    <form id="update_order_form">
        <select class="js-example-basic-multiple" name="issue_type" id="issue_type_up_order">
            <option value="Приказ" selected>Приказ</option>
            <option value="Распоряжение" selected>Распоряжение</option>
        </select>
        <input name="issue_idx" id="issue_idx" class="input_css" type="text" placeholder="Номер №">
        <input name="approving_date" id="approving_date" class="input_css" type="date" >
        <input name="title" id="title" class="input_css" type="text" placeholder="Тема">

        <select class="initiator" name="initiator" id="initiator_up_order" multiple="multiple"></select>
        <br><br>
        <select class="approving_employee" name="approving_employee" id="approving_employee_up_order" multiple="multiple"></select>
        <br><br>
        <select class="employee_order" name="employee_order" id="employee_order_up_order" multiple="multiple"></select>

        <input name="deadline" id="deadline" class="input_css" type="date" >
        <input name="comment" id="comment" class="input_css" type="text" placeholder="Примечание">
        <input name="reference" id="reference" class="input_css" type="link" placeholder="Ссылка">

<!--        <input type="submit" class="input_css" name="submit" value="Сохранить">-->
        <input type="button" class="input_css" name="submit" value="Сохранить" onclick="update_order()">
    </form>
</div>

<div style="text-align: center" id="add_suborder" class="modalwin">
    <form id="add_suborder_form" action="" method="post" onsubmit="return addActionForm('add_suborder_form', 'add_suborder');">
        <select name="employee_sub_order" id="employee_sub_order" multiple="multiple"></select>
        <input name="deadline" class="input_css" type="text" onfocus="(this.type='date')" onblur="(this.value == '' ? this.type='text' : this.type='date')" placeholder="Исполнить до...">
        <textarea name="content" type="text" placeholder="Описание поручения"></textarea>
        <input type="submit" class="input_css" name="submit" value="Сохранить">
    </form>
</div>

<div style="text-align: center" id="close_suborder" class="modalwin">
    <form action="" id="close_suborder_form" method="post" onsubmit="return addActionForm('close_suborder_form', 'close_suborder', 'closing_by_the_administrator');">
        <textarea name="comment_suborder" id="comment_suborder" type="text" placeholder="Комментарии"></textarea>
        <input type="submit" class="input_css" name="submit" value="Закрыть">
    </form>
</div>

<div style="text-align: center" id="update_suborder" class="modalwin">
    <form id="update_suborder_form" action="" method="post" onsubmit="return addActionForm('update_suborder_form', 'update_suborder');">
        <select name="employee_up" id="employee_up" multiple="multiple"></select>
        <input name="deadline_up" class="input_css" id="deadline_up" type="date">
        <textarea name="content_up" id="content_up" type="text" placeholder="Описание поручения"></textarea>
        <input name="submit_up" class="input_css" id="submit_up" type="submit" value="Обновить">
    </form>
</div>

<input name="current_order_id" id="current_order_id" type="text" hidden>
<input name="current_suborder_id" id="current_suborder_id" type="text" hidden>

<script>
var HOST = "http://10.0.2.47:8004"
// var HOST = "http://192.168.200.92:8004"

$(document).ready(function() {

    $('#initiator').select2({
        placeholder: "Выбирите инициатора"});

    $('#approving_employee').select2({
        placeholder: "Выбирите утверждающего руководителя"});

    $('#employee_order').select2({
        placeholder: "Выбирите ответственного исполнителя"});

    $('#employee_sub_order').select2({
        placeholder: "Выбирите исполнителя"});

    $('#employee_up').select2({
        placeholder: "Выбирите исполнителя"});

    $('#initiator_up_order').select2({
        placeholder: "Выбирите инициатора"});

    $('#approving_employee_up_order').select2({
        placeholder: "Выбирите утверждающего руководителя"});

    $('#employee_order_up_order').select2({
        placeholder: "Выбирите ответственного исполнителя"});

    function link(cell, formatterParams){
        var url = cell.getValue();
        return url;
    }


    var url = `${HOST}/get_order`;

    $.get(url, function(response) {

        var orders = new Tabulator('#orders', {
        selectable: 1,
        pagination: 'local',
        paginationSize: 10,
        data: JSON.parse(response),
        layout: 'fitColumns',
        columns: [
                    { title: 'Вид поручения',             field: 'issue_type',          headerFilter: "input"},
                    { title: 'Номер №',                   field: 'issue_idx',           headerFilter: "input"},
                    { title: 'Дата утверждения',          field: 'approving_date',      headerFilter: "input"},
                    { title: 'Тема',                      field: 'title',               headerFilter: "input"},
                    { title: 'Инициатор',                 field: 'initiator',           headerFilter: "input"},
                    { title: 'Утверждающий руководитель', field: 'approving_employee',  headerFilter: "input"},
                    { title: 'Ответственный исполнитель', field: 'employee',            headerFilter: "input"},
                    { title: 'Cтатус',                    field: 'status_code',         headerFilter: "input"},
                    { title: 'Прогресс',                  field: 'progress', sorter: 'number', formatter: 'progress', editorParams:{min:1, max:100}},
                    { title: 'Срок исполнения',           field: 'deadline',            headerFilter: "input"},
                    { title: 'Примечание',                field: 'comment',             headerFilter: "input"},
                    { title: 'Ссылка',                    field: 'reference',           headerFilter: "input",
                      formatter:"link", formatterParams : {
                                                            target:"_blank",
                                                            url:link } }
                 ],

        rowClick:function(e, row){

            updating_data_form_order(row)

            $("#update_order_btn").show(300)

            $("#current_suborder_id").val("")
            $("#close_task").hide(300)
            $("#delete_suborder_btn").hide(300)
            $("#update_suborder_btn").hide(300)

            if (row.getData().status_code == 'На исполнении' || row.getData().status_code == 'Завершено') {

                var url = `${HOST}/get_suborder/${row.getData().id}`;

                    $.get(url, function(response) {

                    var suborders = new Tabulator('#suborders', {
                    selectable: 1,
                    pagination: 'local',
                    paginationSize: 10,
                    data: JSON.parse(response),
                    layout: 'fitColumns',
                    columns: [
                                { title: 'Исполнитель', field: 'employee'},
                                { title: 'Срок исполнения', field: 'deadline'},
                                { title: 'Текст поручения', field: 'content'},
                                { title: 'Статус', field: 'status_code'},
                                { title: 'Состояние', field:"condition", formatter:"tickCross"},
                                { title: 'Комментарии', field: 'comment'}
                             ],

                    rowClick:function(e, row){

                        fillingUpdatingFields(row)

                        if (row.getData().status_code == 'На исполнении') {
                            visible_element_suborder(row)
                        } else {
                            hide_element_suborder()
                        }
                    }
                    })

                })
                $("#suborders").show(300)
                $("#current_order_id").val(row.getData().id)
                $("#suborders_manual").show(300)

            } else {
              $("#suborders").hide(300)
              $("#current_order_id").val("")
              $("#suborders_manual").hide(300)

            }
        }
        });
    });
});

function updating_data_form_order(row) {

    var data_row = row.getData();

    $('#issue_type_up_order').val(data_row.issue_type)

    $('#issue_idx').val(data_row.issue_idx)

    let myDate1 = data_row.deadline;
    let str1 = myDate1.replace(/(\d+)\.(\d+)\.(\d+)/, '$3-$2-$1');
    $("#approving_date").val(str1).change();

    $('#title').val(data_row.title);

    var array = data_row.initiator.split(", ");
    $('#initiator_up_order').val(array).change();

    var array = data_row.approving_employee.split(", ");
    $('#approving_employee_up_order').val(array).change();

    var array = data_row.employee.split(", ");
    $('#employee_order_up_order').val(array).change();

    let myDate2 = data_row.deadline;
    let str2 = myDate2.replace(/(\d+)\.(\d+)\.(\d+)/, '$3-$2-$1');
    $("#deadline").val(str2).change();

    $('#comment').val(data_row.comment);

    $('#reference').val(data_row.reference);



// <!--    let myDate = row.getData().deadline;-->
// <!--    let str = myDate.replace(/(\d+)\.(\d+)\.(\d+)/, '$3-$2-$1');-->

// <!--    $("#deadline_up").val(str).change();-->
// <!--    $("#content_up").val(row.getData().content);-->
}

function fillingUpdatingFields(row) {

    var string = row.getData().employee;
    var array = string.split(", ");
    $('#employee_up').val(array).change();


    let myDate = row.getData().deadline;
    let str = myDate.replace(/(\d+)\.(\d+)\.(\d+)/, '$3-$2-$1');

    $("#deadline_up").val(str).change();
    $("#content_up").val(row.getData().content);
}

function visible_element_suborder(row) {
    $("#current_suborder_id").val(row.getData().id)
    $("#close_task").show(300)
    $("#delete_suborder_btn").show(300)
    $("#update_suborder_btn").show(300)
}

function hide_element_suborder() {
    $("#current_suborder_id").val("")
    $("#close_task").hide(300)
    $("#delete_suborder_btn").hide(300)
    $("#update_suborder_btn").hide(300)
}

async function update_order(){

    let url = new URL(`${HOST}/update_order`);

    url.searchParams.set('id', document.getElementById('current_order_id').value)
    url.searchParams.set('deadline', document.getElementById('deadline').value)
    url.searchParams.set('comment', document.getElementById('comment').value)
    url.searchParams.set('issue_idx', document.getElementById('issue_idx').value)
    url.searchParams.set('issue_type', document.getElementById('issue_type_up_order').value)
    url.searchParams.set('approving_date', document.getElementById('approving_date').value)
    url.searchParams.set('title', document.getElementById('title').value)

    let response = await fetch(url, {
        method: 'POST',
        headers:{
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            'employee': $('#employee_order_up_order').val(),
            'initiator': $('#initiator_up_order').val(),
            'approving_employee': $('#approving_employee_up_order').val()
        })
    });

    if (response.ok) {
// <!--        location.reload();-->
//     } else {
        alert("Ошибка HTTP: " + response.status);
    }


}

function addActionForm() {
    var order_id = escape(document.getElementById('current_order_id').value);
    var suborder_id = escape(document.getElementById('current_suborder_id').value);

    if (arguments[1] == 'add_suborder'){
        document.getElementById(arguments[0]).action = '/' + arguments[1] + '/' + order_id
    } else if (arguments[1] == 'update_suborder') {
        document.getElementById(arguments[0]).action = '/' + arguments[1] + '/' + order_id + '/' + suborder_id
    } else if (arguments[1] == 'update_order') {
        document.getElementById(arguments[0]).action = '/update_order'
    } else {
        document.getElementById(arguments[0]).action = '/' + arguments[1] + '/' + order_id + '/' + suborder_id + '/' + arguments[2]
    }
}

function deleteSuborder() {
    var isDelete = confirm("Подвердите удаление поручения.");

    if (isDelete == true) {
        $.post(`${HOST}/delete_suborder/` +
        document.getElementById('current_order_id').value +"/"+
        document.getElementById('current_suborder_id').value, function(response){
            })
        }
}

</script>

<script>


    function showModalWin() {
        var darkLayer = document.createElement('div'); // слой затемнения
        darkLayer.id = 'shadow'; // id чтобы подхватить стиль
        document.body.appendChild(darkLayer); // включаем затемнение
        var modalWin = document.getElementById(arguments[0]); // находим наше "окно"
        modalWin.style.display = 'block'; // "включаем" его
        darkLayer.onclick = function () {  // при клике на слой затемнения все исчезнет
        darkLayer.parentNode.removeChild(darkLayer); // удаляем затемнение
        modalWin.style.display = 'none'; // делаем окно невидимым
            return false;
            };
        }

    function hiddenModalWin() {
        var modalWin = document.getElementById(arguments[0]);
        modalWin.style.display = 'none';

        var darkLayer = document.createElement('div');
        darkLayer.id = 'shadow';
        darkLayer.parentNode.removeChild(darkLayer);
    }


</script>

<script>

    var HOST = "http://10.0.2.47:8004"
    // var HOST = "http://192.168.200.92:8004"


    var users = $.get( `${HOST}/get_users`, function(response) {
        $.each(JSON.parse(response), function(key, value) {

            $('#approving_employee, #initiator, #employee_order, #employee_sub_order, #employee_up, #initiator_up_order, #approving_employee_up_order, #employee_order_up_order')
            .append($("<option></option>")
                        .attr("value", value)
                        .text(value));
        });
    });



</script>

<script>
    var HOST = "http://10.0.2.47:8004"
    // var HOST = "http://192.168.200.92:8004"
    async function get_report(){
        url = new URL(`${HOST}/report_by_period`)
        url.searchParams.append('start_period', document.getElementById('date_start').value);
        url.searchParams.append('end_period', document.getElementById('date_end').value);
        window.location.href = url;
    }

</script>
</body>


